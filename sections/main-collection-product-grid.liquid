<script src="{{ 'shop.js' |  asset_url }}" defer></script>
<script src="{{ 'facets.js' |  asset_url }}" defer></script>

<div class="flat-spacing">
  <div class="container">
    <div class="tf-shop-control">
      <div class="tf-control-filter">
        <a href="#filterShop" data-bs-toggle="offcanvas" aria-controls="filterShop" class="tf-btn-filter">
          <span class="icon icon-filter"></span><span class="text">Filter</span></a
        >
      </div>
      <ul class="tf-control-layout">
        <li class="tf-view-layout-switch sw-layout-2" data-value-layout="tf-col-2">
          <i class="icon-grid-2"></i>
        </li>
        <li class="tf-view-layout-switch sw-layout-3 d-none d-md-flex" data-value-layout="tf-col-3">
          <i class="icon-grid-3"></i>
        </li>
        <li class="tf-view-layout-switch sw-layout-4 d-none d-xl-flex active" data-value-layout="tf-col-4">
          <i class="icon-grid-4"></i>
        </li>
        <li class="tf-view-layout-switch sw-layout-5 d-none d-xxl-flex" data-value-layout="tf-col-5">
          <i class="icon-grid-5"></i>
        </li>
        <li class="tf-view-layout-switch sw-layout-6 d-none d-xxl-flex" data-value-layout="tf-col-6">
          <i class="icon-grid-6"></i>
        </li>
        <li class="br-line type-vertical"></li>
        <li class="tf-view-layout-switch sw-layout-list list-layout" data-value-layout="list">
          <i class="icon-list"></i>
        </li>
      </ul>

      {% comment %} Sorting Controller {% endcomment %}
      <facet-filters-form>
        <form id="FacetSortForm" method="get" class="facet-filters-form position-static">
          <div class="tf-control-sorting">
            <p class="h6 d-none d-lg-block">Sort by:</p>
            <div class="tf-dropdown-sort" data-bs-toggle="dropdown">
              {%- assign sort_by = collection.sort_by | default: collection.default_sort_by -%}
              {%- assign selected_option = collection.sort_options | where: 'value', sort_by | first -%}
              <div class="btn-select">
                <span class="text-sort-value">{{ selected_option.name }}</span>
                <span class="icon icon-caret-down"></span>
              </div>
              <div class="dropdown-menu">
                {%- for option in collection.sort_options -%}
                  <div 
                    class="select-item{% if option.value == sort_by %} active{% endif %}" 
                    data-sort-value="{{ option.value | escape }}"
                  >
                    <span class="text-value-item">{{ option.name | escape }}</span>
                  </div>
                {%- endfor -%}
              </div>
              <input type="hidden" name="sort_by" value="{{ sort_by }}">
            </div>
          </div>
        </form>
      </facet-filters-form>
    </div>

    {% comment %} Column {% endcomment %}
    <div id="ProductGridContainer" class="position-relative">
      <div class="collection-loading-overlay"></div>
      <div id="product-grid" data-id="{{ section.id }}">

        {% comment %} individual remove buttons {% endcomment %}
        <div class="meta-filter-shop">
          <span id="ProductCount">
            {%- if collection.results_count -%}
              {{ 'templates.search.results_with_count' | t: terms: collection.terms, count: collection.results_count }}
            {%- elsif collection.products_count == collection.all_products_count -%}
              {{ 'products.facets.product_count_simple' | t: count: collection.products_count }}
            {%- else -%}
              {{ 'products.facets.product_count' | t: product_count: collection.products_count, count: collection.all_products_count }}
            {%- endif -%}
          </span>

          <div class="active-facets active-facets-desktop d-flex flex-wrap gap-2">
            {%- for filter in collection.filters -%}
              {%- for value in filter.active_values -%}
                <facet-remove>
                  <a href="{{ value.url_to_remove }}" class="active-facets__button active-facets__button--light">
                    <span class="active-facets__button-inner filter-tag remove-tag ">
                      <span class="icon icon-close">
                      </span>
                      {{ filter.label | escape }}: {{ value.label | escape }}
                      <span class="visually-hidden">{{ 'products.facets.clear_filter' | t }}</span>
                    </span>
                  </a>
                </facet-remove>
              {%- endfor -%}
              
              {% comment %} {% if filter.type == 'price_range' %}
                {% assign min = filter.min_value.value %}
                {% assign max = filter.max_value.value %}
                {%- if min != null or max != null -%}
                  <facet-remove>
                    <a href="{{ filter.url_to_remove }}" class="active-facets__button active-facets__button--light">
                      <span class="active-facets__button-inner button button--tertiary">
                        {{ min | default: 0 | money }} - {{ max | default: filter.range_max | money }}
                        <span class="svg-wrapper">
                          {{- 'icon-close-small.svg' | inline_asset_content -}}
                        </span>
                        <span class="visually-hidden">{{ 'products.facets.clear_filter' | t }}</span>
                      </span>
                    </a>
                  </facet-remove>
                {%- endif -%}
              {% endif %} {% endcomment %}
            {%- endfor -%}
            <facet-remove class="active-facets__button-wrapper">
              <a href="{{ collection.url }}" class="active-facets__button-remove underlined-link">
                <span class="remove-all-filters">
                  <span class="icon icon-close"></span>
                  {{ 'products.facets.clear_all' | t }}</span>
              </a>
            </facet-remove>
          </div>
        </div>

        {% comment %} Grid layouts {% endcomment %}
        <div class="wrapper-shop tf-grid-layout tf-col-4" id="gridLayout">
          {%- paginate collection.products by 12 -%}
            {%- for product in collection.products -%}
              {% render 'card-product', product: product %}
            {%- endfor -%}

            {%- if paginate.pages > 1 -%}
              <!-- Pagination -->
              {% render 'pagination', paginate: paginate %}
            {%- endif -%}
          {%- endpaginate -%}
        </div>
        {% comment %} Grid layouts ends {% endcomment %}

        {% comment %} List layout {% endcomment %}
        <div class="tf-list-layout wrapper-shop" id="listLayout" style="display: none;">
          {%- paginate collection.products by 12 -%}
            {%- for product in collection.products -%}
              {% render 'card-product-horizontal', product: product, truncate_words: section.settings.truncate_words %}
            {%- endfor -%}
            
            {%- if paginate.pages > 1 -%}
              <!-- Pagination -->
              {% render 'pagination', paginate: paginate %}
            {%- endif -%}
          {%- endpaginate -%}
        </div>
        {% comment %} List layout ends{% endcomment %}

      </div>
    </div>
  </div>
</div>

{% comment %} filter Sidebar {% endcomment %}
<facet-filters-form>
  <form id="FacetFiltersForm" method="get" class="facet-filters-form position-static">
    {%- if collection.terms -%}
      <input type="hidden" name="q" value="{{ collection.terms | escape }}">
      <input name="options[prefix]" type="hidden" value="last">
    {%- endif -%}
    <div class="offcanvas offcanvas-start canvas-filter" id="filterShop">
      <div class="canvas-wrapper">
        <div class="canvas-header">
          <span class="title h3 fw-medium">Filter</span>
          <span class="icon-close link icon-close-popup fs-24" data-bs-dismiss="offcanvas"></span>
        </div>

        <div class="canvas-body">

          {% for filter in collection.filters %}

            <div class="widget-facet js-filter" id="Filter-{{ filter.param_name | handle }}">
              <div
                class="facet-title"
                data-bs-target="#filter-{{ filter.param_name | handle }}"
                role="button"
                data-bs-toggle="collapse"
                aria-expanded="true"
              >
                <span class="h4 fw-semibold">{{ filter.label }}</span>
                <span class="icon icon-caret-down fs-20"></span>
              </div>

              <div id="filter-{{ filter.param_name | handle }}" class="collapse show">

                {% case filter.type %}

                  {% when 'list' %}

                    {%- assign filter_label = filter.label | downcase -%}

                    {%- if filter_label == 'color' -%}
                      <!-- COLOR (swatches) -->
                      <div class="collapse-body filter-color-box flat-check-list">
                        {% for value in filter.values %}
                          <label
                            class="check-item color-item color-check position-relative {% if value.active %}active{% endif %}"
                            for="Filter-{{ filter.label | escape }}-{{ forloop.index }}"
                          >
                            <input
                              type="checkbox"
                              id="Filter-{{ filter.label | escape }}-{{ forloop.index }}"
                              name="{{ value.param_name }}"
                              value="{{ value.value }}"
                              class="appearance-hidden"
                              {% if value.active %}checked{% endif %}
                              {% if value.count == 0 and value.active == false %}disabled{% endif %}
                            >
                            {%- assign color_rgb = value.swatch.color.rgb | default: '' -%}
                            <span class="color" 
                            style="
                              {% if color_rgb != blank %}
                                background-color: rgb({{ color_rgb }}) !important;
                              {% else %}
                                background-color: {{ value.value }} !important;
                              {% endif %}
                            "></span>
                            <span class="color-text">{{ value.label | escape }}</span>
                          </label>
                        {% endfor %}
                      </div>

                    {%- elsif filter_label == 'size' -%}
                      <!-- SIZE (boxes) -->
                      <div class="collapse-body filter-size-box flat-check-list">
                        {% for value in filter.values %}
                          <label
                            class="check-item size-item size-check position-relative {% if value.active %}active{% endif %}"
                            for="size-{{ forloop.index }}"
                          >
                            <input
                              type="checkbox"
                              id="size-{{ forloop.index }}"
                              name="{{ value.param_name }}"
                              value="{{ value.value }}"
                              class="appearance-hidden"
                              {% if value.active %}checked{% endif %}
                              {% if value.count == 0 and value.active == false %}disabled{% endif %}
                            >
                            <span class="size h6">{{ value.label }}</span>
                          </label>
                        {% endfor %}
                      </div>

                    {%- else -%}
                      <!-- DEFAULT LIST (brand, availability, etc.) -->
                      <ul class="collapse-body filter-group-check current-scrollbar">
                        {% for value in filter.values %}
                          <li class="list-item {% if value.count == 0 and value.active == false %}disabled{% endif %}">
                            <input
                              type="checkbox"
                              class="tf-check"
                              name="{{ value.param_name }}"
                              value="{{ value.value }}"
                              id="{{ value.param_name | handle }}-{{ forloop.index }}"
                              {% if value.active %}checked{% endif %}
                              {% if value.count == 0 and value.active == false %}disabled{% endif %}
                            >
                            <label for="{{ value.param_name | handle }}-{{ forloop.index }}" class="label">
                              <span>{{ value.label }}</span>
                              <span class="count">{{ value.count }}</span>
                            </label>
                          </li>
                        {% endfor %}
                      </ul>

                    {%- endif -%}

                {% endcase %}

              </div>
            </div>
          {% endfor %}
        </div>

        <div class="canvas-bottom">
          <facet-remove>
            <a href="{{ collection.url }}" class="tf-btn btn-reset">
              Reset Filters
            </a>
          </facet-remove>
        </div>
      </div>
    </div>
  </form>
</facet-filters-form>
{% comment %} filter Sidebar ends {% endcomment %}

{% schema %}
{
  "name": "Main Collection",
  "settings": [
      {
        "type": "number",
        "id": "truncate_words",
        "label": "Truncate words",
        "default": 30
      }
    ]
}
{% endschema %}